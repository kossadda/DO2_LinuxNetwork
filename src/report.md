# Сети в Linux

Настройка сетей в Linux на виртуальных машинах.


## Оглавление

1. [Part 1. Инструмент ipcalc](#part-1-инструмент-ipcalc) <br>
   1.1. [Сети и маски](#11-сети-и-маски) <br>
   1.2. [localhost](#12-localhost) <br>
   1.3. [Диапазоны и сегменты сетей](#13-диапазоны-и-сегменты-сетей)
2. [Part 2. Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами) <br>
   2.1. [Добавление статического маршрута вручную](#21-добавление-статического-маршрута-вручную) <br>
   2.2. [Добавление статического маршрута с сохранением](#22-добавление-статического-маршрута-с-сохранением)
3. [Part 3. Утилита iperf3](#part-3-утилита-iperf3) <br>
   3.1. [Скорость соединения](#31-скорость-соединения) <br>
   3.2. [Утилита iperf3](#32-утилита-iperf3)
4. [Part 4. Сетевой экран](#part-4-сетевой-экран) <br>
   4.1. [Утилита iptables](#41-утилита-iptables) <br>
   4.2. [Утилита nmap](#42-утилита-nmap)
5. [Part 5. Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети) <br>
   5.1. [Настройка адресов машин](#51-настройка-адресов-машин) <br>
   5.2. [Включение переадресации IP-адресов](#52-включение-переадресации-ip-адресов) <br>
   5.3. [Установка маршрута по-умолчанию](#53-установка-маршрута-по-умолчанию) <br>
   5.4. [Добавление статических маршрутов](#54-добавление-статических-маршрутов) <br>
   5.5. [Построение списка маршрутизаторов](#55-построение-списка-маршрутизаторов) <br>
   5.6. [Использование протокола ICMP при маршрутизации](#56-использование-протокола-icmp-при-маршрутизации)

## Part 1. Инструмент ipcalc

- Установка утилиты ipcalc <br>

`sudo apt install ipcalc` <br>
<img src="../misc/images/1.jpg" alt="1" /> <br>

### 1.1. Сети и маски

**1) Определение адреса сети 192.167.38.54/13:**

`ipcalc 192.167.38.54/13` <br>
<img src="../misc/images/2.jpg" alt="2" /> <br>

**2) Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную:**

- Перевод маски 255.255.255.0 в префиксную и двоичную запись: <br>
`ipcalc 255.255.255.0` <br>
<img src="../misc/images/3.jpg" alt="3" />

**Префиксная запись:** 24 <br>
**Двоичная запись:** 11111111.11111111.11111111.00000000

- Перевод /15 в обычную и двоичную запись:<br>
`ipcalc /15` <br>
<img src="../misc/images/4.jpg" alt="4" />

**Префиксная запись:** 255.254.0.0 <br>
**Двоичная запись:** 11111111.11111110.00000000.00000000

- Перевод 11111111.11111111.11111111.11110000 в обычную и префиксную запись:<br>
`ipcalc /28` <br>
<img src="../misc/images/5.jpg" alt="5" />

**Префиксная запись:** 255.255.255.240 <br>
**Двоичная запись:** 11111111.11111110.00000000.00000000

**3) Определить минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4:**

- Минимальный и максимальный хост в сети 12.167.38.4 (при маске /8) <br>
`ipcalc 12.167.38.4/8` <br>
<img src="../misc/images/6.jpg" alt="6" />

**Минимальный хост:**  12.0.0.1 <br>
**Максимальный хост:** 12.255.255.254

- Минимальный и максимальный хост в сети 12.167.38.4 (при маске 11111111.11111111.00000000.00000000) <br>
`ipcalc 12.167.38.4/16` <br>
<img src="../misc/images/7.jpg" alt="7" />

**Минимальный хост:**  12.167.0.1 <br>
**Максимальный хост:** 12.167.255.254

- Минимальный и максимальный хост в сети 12.167.38.4 (при маске 255.255.254.0) <br>
`ipcalc 12.167.38.4/23` <br>
<img src="../misc/images/8.jpg" alt="8" />

**Минимальный хост:**  12.167.38.1 <br>
**Максимальный хост:** 12.167.39.254

- Минимальный и максимальный хост в сети 12.167.38.4 (при маске /4) <br>
`ipcalc 12.167.38.4/4` <br>
<img src="../misc/images/9.jpg" alt="9" />

**Минимальный хост:**  12.167.38.1 <br>
**Максимальный хост:** 12.167.39.254

### 1.2. localhost
**Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1** <br>

> Адреса 127.0.0.0 до 127.255.255.255  также известные как адреса петли обратной связи (loopback addresses), представляют собой специальный диапазон IP-адресов, предназначенных для локального обмена данными в пределах компьютера (localhost). Этот диапазон адресов не маршрутизируется через сеть и используется для обеспечения сетевой изоляции и локальной отладки приложений и сервисов на компьютере.
Адреса петли обратной связи полезны для тестирования и разработки на локальной машине, так как они позволяют приложениям и сервисам общаться между собой без необходимости подключения к внешней сети
194.34.23.100 – нет доступа
127.0.0.2 – имеется доступ
127.1.0.1 – имеется доступ
128.0.0.1 – нет доступа

`ipcalc 127.0.0.2` <br>
`ipcalc 127.1.0.1` <br>
<img src="../misc/images/10.jpg" alt="10" />

**В пункте Hosts/Net присутствует пометка Loopback.**

`ipcalc 194.34.23.100` <br>
`ipcalc 128.0.0.1` <br>
<img src="../misc/images/11.jpg" alt="11" />

**В пункте Hosts/Net отсутствует пометка Loopback.** <br>
*Данные адреса не принадлежат диапазону зарезервированных адресов для локального использования. Следовательно, обращения к приложению на localhost с этими IP-адресами не будут работать.*

### 1.3. Диапазоны и сегменты сетей

**1) Определить какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1:**

- Частные IP-адреса: <br>
10.0.0.45/8       - Privat <br>
192.168.4.2/16    - Privat <br>
172.20.250.4/12   - Privat <br>
172.16.255.255/12 - Privat <br>
10.10.10.10/8     - Privat <br>
- Публичные IP-адреса: <br>
134.43.0.2/16     - Public <br>
172.0.2.1/12      - Public <br>
192.172.0.1/12    - Public <br>
172.68.0.2/12     - Public <br>
192.169.168.1/16  - Public <br>

**2) Определить какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255:**

`ipcalc 10.10.0.0/18` <br>
<img src="../misc/images/12.jpg" alt="12" />

Диапазон возможных IP адресов шлюза варьируются от 10.10.0.1 (HostMin) – 10.10.63.254 (HostMax). Следовательно, возможными IP адресами шлюза являются: **10.10.0.2, 10.10.10.10, 10.10.1.255**

## Part 2. Статическая маршрутизация между двумя машинами

**Поднять две виртуальные машины (далее -- ws1 и ws2)**

- С помощью команды `ip a` посмотреть существующие сетевые интерфейсы:

**ws1:** `ip a` <br>
<img src="../misc/images/13.jpg" alt="13" /> <br>
**ws2:** `ip a` <br>
<img src="../misc/images/13_1.jpg" alt="13_1" />

> ***lo (Loopback):*** <br>
***Тип:*** Локальный сетевой интерфейс. <br>
***Описание:*** Интерфейс петли обратной связи (loopback interface). <br>
***IP-адрес:*** Обычно устанавливается на 127.0.0.1 (localhost). <br>
***Назначение:*** Используется для внутренней обратной связи на локальном компьютере. Все сетевые запросы к 127.0.0.1 обрабатываются локально, без передачи по сети. Часто используется для тестирования и локальной разработки. <br>
**ws1: 127.0.0.1/8** <br>
**ws2: 127.0.0.1/8**

> **enp0s3:** <br>
***Тип:*** Физический сетевой интерфейс (Ethernet). <br>
***Описание:*** Сетевой интерфейс, который связан с физической сетевой картой на компьютере. <br>
***IP-адрес:*** Может иметь IP-адрес, который используется для связи с другими устройствами в сети. <br>
***Назначение:*** Используется для подключения вашего компьютера к сети, включая локальную сеть (LAN) или сеть Интернет. Этот интерфейс обеспечивает сетевую связь вашего компьютера с другими устройствами в сети. <br>
**ws1: 10.0.2.15/24** <br>
**ws2: 10.0.2.15/24** <br>

Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12

- Открыть файл конфигурации сетевых интерфейсов и внести необходимые изменения: <br>

**ws1:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/14.jpg" alt="14" /> <br>
**ws2:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/14_1.jpg" alt="14_1" />

- Выполнить команду `netplan apply` для перезапуска сервиса сети: <br>

**ws1:** `sudo netplan apply` <br>
<img src="../misc/images/15.jpg" alt="15" /> <br>
**ws2:** `sudo netplan apply` <br>
<img src="../misc/images/15_1.jpg" alt="15_1" />

### 2.1. Добавление статического маршрута вручную

- Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`: <br>

**ws1:** `sudo ip r add 172.24.116.8 dev enp0s3` <br>
**ws2:** `sudo ip r add 192.168.100.10 dev enp0s3` <br>

- Пропинговать соединение между машинами: <br>

**ws1:** `ping 172.24.116.8` <br>
<img src="../misc/images/16.jpg" alt="16" /> <br>
**ws2:** `ping 192.168.100.10` <br>
<img src="../misc/images/16_1.jpg" alt="16_1" />

### 2.2. Добавление статического маршрута с сохранением

- Перезапустить машины

- Добавить статический маршрут от одной машины до другой с помощью файла `etc/netplan/00-installer-config.yaml`: <br>

**ws1:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/17.jpg" alt="17" /> <br>
**ws2:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/17_1.jpg" alt="17_1" />

- Пропинговать соединение между машинами: <br>

**ws1:** `ping -c 3 172.24.116.8` <br>
<img src="../misc/images/18.jpg" alt="18" /> <br>
**ws2:** `ping -c 3 192.168.100.10` <br>
<img src="../misc/images/18_1.jpg" alt="18_1" />

## Part 3. Утилита iperf3

### 3.1. Скорость соединения:

- Перевести и записать в отчёт: 8 Mbps в MB/s**, 100 MB/s в Kbps, 1 Gbps в Mbps:
> 8 Mbps = 1 MB/s; <br>
100 MB/s = 800000 Kbps; <br>
1 Gbps = 1000 Mbps;

### 3.2. Утилита iperf3:

- Измерить скорость соединения между ws1 и ws2: <br>

**ws1:** `iperf3 -s -f K` <br>
<img src="../misc/images/19.jpg" alt="19" /> <br>
**ws2:** `iperf3 -c 192.168.100.10 -f K` <br>
<img src="../misc/images/19_1.jpg" alt="19_1" />

## Part 4. Сетевой экран

### 4.1. Утилита iptables

- Создать файл `/etc/firewall.sh`, имитирующий фаерволл, на ws1 и ws2: <br>

**Нужно добавить в файл подряд следующие правила:** <br>
1. на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5) <br>
2. на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5) <br>
3. открыть на машинах доступ для порта 22 (ssh) и порта 80 (http) <br>
4. запретить echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT) <br>
5. разрешить echo reply (машина должна "пинговаться") <br>

- Содержимое файла /etc/firewall для машины ws1 и ws2: <br>

**ws1:** `sudo vim /etc/firewall.sh` <br>
<img src="../misc/images/20.jpg" alt="20" /> <br>
**ws2:** `sudo vim /etc/firewall.sh` <br>
<img src="../misc/images/20_1.jpg" alt="20_1" />

>**iptables -F:** <br>
Очищает все правила в таблице фильтрации (Filter table) iptables. Это означает, что все текущие настройки брандмауэра будут удалены, и трафик будет разрешен по умолчанию. <br>
**iptables -X:** <br>
Удаляет все пользовательские цепочки правил из таблицы фильтрации. Цепочки - это наборы правил, которые определяют, как обрабатывать определенные типы трафика. <br>
**iptables -A INPUT -p tcp --dport 22(80) -j ACCEPT:** <br>
Добавляет правило в цепочку INPUT (цепочка входящего трафика) таблицы фильтрации. Правило разрешает входящий TCP-трафик на порт 22 (SSH) или 80 (HTTP) и направляет его на цель ACCEPT, что означает разрешение трафика на этих портах. <br>
**iptables -A OUTPUT -p icmp --icmp-type echo-reply -j DROP:** <br>
Добавляет правило в цепочку OUTPUT (цепочка исходящего трафика) таблицы фильтрации. Правило блокирует исходящий ICMP-трафик с типом "echo-reply" (ответ на пинг) и направляет его на цель DROP, что означает отбрасывание такого трафика. <br>
**iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT:** <br>
Добавляет другое правило в цепочку OUTPUT, но оно разрешает исходящий ICMP-трафик с типом "echo-reply" и направляет его на цель ACCEPT, что означает разрешение такого трафика. <br>
**/sbin/iptables-save:** <br>
Сохраняет текущие настройки брандмауэра iptables в файле (обычно в /etc/sysconfig/iptables или /etc/iptables/rules.v4). Это позволяет сохранить настройки, чтобы они автоматически применялись при перезагрузке системы или после очистки правил. <br>

- Запустить файлы на обеих машинах: <br>

**ws1:** `chmod +x /etc/firewall.sh` , `/etc/firewall.sh` <br>
<img src="../misc/images/21.jpg" alt="21" /> <br>
**ws2:** `chmod +x /etc/firewall.sh` , `/etc/firewall.sh` <br>
<img src="../misc/images/21_1.jpg" alt="21_1" />

### 4.2. Утилита nmap

**Командой ping найти машину, которая не "пингуется", после чего утилитой nmap показать, что хост машины запущен:** <br>

> Проверка: в выводе nmap должно быть сказано: **Host is up**

**ws1:** `ping 172.24.116.8` <br>
<img src="../misc/images/22.jpg" alt="22" /> <br>
**ws2:** `ping 192.168.100.10` <br>
<img src="../misc/images/22_1.jpg" alt="22_1" />

`nmap -Pn 192.168.100.10` <br>
<img src="../misc/images/23.jpg" alt="23" />

## Part 5. Статическая маршрутизация сети

**Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)):** <br>

### 5.1. Настройка адресов машин

- Настроить конфигурации машин в `etc/netplan/00-installer-config.yaml` согласно сети на рисунке:

<img src="../misc/images/24.jpg" alt="24" />

- Содержимое `etc/netplan/00-installer-config.yaml` для машин

**ws11:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/25_1.jpg" alt="25_1" /> <br>
**ws21:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/25_2.jpg" alt="25_2" /> <br>
**ws22:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/25_3.jpg" alt="25_3" /> <br>
**r1:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/25_4.jpg" alt="25_4" /> <br>
**r2:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/25_5.jpg" alt="25_5" /> <br>

- Перезапустить сервис сети. Если ошибок нет, то командой `ip -4` a проверить, что адрес машины задан верно:

**ws11:** `ip -4 a` <br>
<img src="../misc/images/26_1.jpg" alt="26_1" /> <br>
**ws21:** `ip -4 a` <br>
<img src="../misc/images/26_2.jpg" alt="26_2" /> <br>
**ws22:** `ip -4 a` <br>
<img src="../misc/images/26_3.jpg" alt="26_3" /> <br>
**r1:** `ip -4 a` <br>
<img src="../misc/images/26_4.jpg" alt="26_4" /> <br>
**r2:** `ip -4 a` <br>
<img src="../misc/images/26_5.jpg" alt="26_5" /> <br>

- Пропинговать ws22 с ws21:

**ws21:** `ping 10.20.0.20` <br>
<img src="../misc/images/27.jpg" alt="27" /> <br>

- Аналогично пропинговать r1 с ws11:

**r1:** `ping 10.10.0.1` <br>
<img src="../misc/images/28.jpg" alt="28" /> <br>

### 5.2. Включение переадресации IP-адресов

- Для включения переадресации IP, выполнить команду на роутерах:

**r1:** `sysctl -w net.ipv4.ip_forward=1` <br>
<img src="../misc/images/29_1.jpg" alt="29_1" /> <br>
**r2:** `sysctl -w net.ipv4.ip_forward=1` <br>
<img src="../misc/images/29_2.jpg" alt="29_2" /> <br>

- Открыть файл `/etc/sysctl.conf` на обоих роутерах и добавить в него следующую строку `net.ipv4.ip_forward = `:

<img src="../misc/images/30.jpg" alt="30" /> <br>

### 5.3. Установка маршрута по-умолчанию

**Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить default перед IP роутера в файле конфигураций**

- Содержимое `etc/netplan/00-installer-config.yaml` для машин:

**ws11:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/31_1.jpg" alt="31_1" /> <br>
**ws21:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/31_2.jpg" alt="31_2" /> <br>
**ws22:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/31_3.jpg" alt="31_3" /> <br>

`sudo netplan apply` <br>

- Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации:

**ws11:** `ip r` <br>
<img src="../misc/images/32_1.jpg" alt="32_1" /> <br>
**ws21:** `ip r` <br>
<img src="../misc/images/32_2.jpg" alt="32_2" /> <br>
**ws22:** `ip r` <br>
<img src="../misc/images/32_3.jpg" alt="32_3" /> <br>

- Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду `tcpdump -tn -i eth1`:

**ws11:** `ping -c 5 10.100.0.12` <br>
<img src="../misc/images/33_1.jpg" alt="33_1" /> <br>
**ws21:** `sudo tcpdmp -tn -i enp0s8` <br>
<img src="../misc/images/33_2.jpg" alt="33_2" /> <br>

### 5.4. Добавление статических маршрутов

- Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций:

**r1:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/34_1.jpg" alt="34_1" /> <br>
**r2:** `sudo vim /etc/netplan/00-installer-config.yaml` <br>
<img src="../misc/images/34_2.jpg" alt="34_2" /> <br>

`sudo netplan apply` <br>

- Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах:

**r1:** `ip r` <br>
<img src="../misc/images/35_1.jpg" alt="35_1" /> <br>
**r2:** `ip r` <br>
<img src="../misc/images/35_2.jpg" alt="35_2" /> <br>

- Запустить команды на ws11 `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`:

`ip r list 10.10.0.0/18` <br>
`ip r list 0.0.0.0/0` <br>
<img src="../misc/images/36.jpg" alt="36" /> <br>

> Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, так как 0.0.0.0/0 будет выбран в том случае, когда другой маршрут не задан в таблице маршрутизации хоста. ws11 находится внутри сети 10.10.0.0/18, и для связи с ней используется IP-адрес 10.10.0.2, поэтому ws11 отправляет данные на роутер, используя маршрут по умолчанию.

### 5.5. Построение списка маршрутизаторов

- При помощи утилиты traceroute построить список маршрутизаторов на пути от ws11 до ws21:

`traceroute 10.20.0.10` <br>
<img src="../misc/images/37.jpg" alt="37" /> <br>

- Запустить на r1 команду дампа:

`tcpdump -tnv -i eth0` <br>
<img src="../misc/images/38.jpg" alt="38" /> <br>

- В отчёте, опираясь на вывод, полученный из дампа на r1, объяснить принцип работы построения пути при помощи traceroute:

> 1. Когда traceroute начинает свою работу, он выбирает IP-адрес конечного узла (например, веб-сервера), к которому вы хотите определить маршрут.
2. traceroute создает ICMP (или UDP, в зависимости от опции) пакет с начальным значением TTL, которое обычно равно 1.
3. Этот пакет отправляется на конечный узел.
4. Когда пакет достигает первого промежуточного роутера, значение TTL уменьшается на 1. Если значение TTL становится равным 0, роутер удаляет пакет и отправляет обратно отправителю сообщение "Time Exceeded" (превышено время).
5. traceroute получает это сообщение "Time Exceeded" и записывает IP-адрес роутера и время, затраченное на достижение этого узла. Затем он увеличивает значение TTL на 1 и отправляет следующий пакет.
6. Процесс повторяется, пока пакет не достигнет конечного узла (конечного пункта назначения). Как только это произойдет, traceroute завершает выполнение и выводит полный маршрут с временными задержками до каждого промежуточного узла.

### 5.6. Использование протокола ICMP при маршрутизации

- Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
- Пропинговать с ws11 несуществующий IP (например, 10.30.0.111) с помощью команды:

`tcpdump -n -i eth0 icmp` <br>
`ping -c 1 10.30.0.111` <br>
<img src="../misc/images/39.jpg" alt="39" /> <br>
<img src="../misc/images/40.jpg" alt="40" /> <br>
